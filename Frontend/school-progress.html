<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="school-progress.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="icon" href="images/favicon.ico" type="image/x-icon">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Do+Hyeon:wght@400&display=swap" rel="stylesheet">
    <title>School Progress</title>
</head>


<body>


    <header>
        <h1><span style="color: rgb(220, 56, 56);">Rampaging chariots</span><br>Construction Tracking</h1>
        <div id="progressContainer">
            <p id="schoolName">Your Progress:</p>
            <div id="progressBar">
                <div id="progressBarFill">10%</div>
            </div>
        </div>
        <div id="pagesContainer">
            <a id="allPropLink" href="./all-progress.html">All Schools</a>
            <a id="docsLink" href="./documents.html">Documents & Help</a>
        </div>
    </header>


    <main>

        <section id="top">
            <div id="tickTitle">
                <img class="tick" src="images/tick.png" alt="Tick">
                <h2>Tick each step once complete</h2>
            </div>
            <div id="clickTitle">
                <img id="cursor" src="images/cursor.png" alt="Cursor press">
                <h2>Click each title to view image</h2>
            </div>
            <span class="terminal">Start</span>
        </section>


        <section id="progress1">
            <div class="path1txt" id="path1txtL">
                <h3 id="team" class="clickh3">Formed a team</h3>
                <h3 id="parts" class="clickh3">Check components list &<br>identified any missing parts</h3>
            </div>
            <div class="path1ticks"  id="path1ticksL">
                <custom-checkbox></custom-checkbox>
                <custom-checkbox></custom-checkbox>
            </div>
            <span class="path"></span>
            <div class="path1ticks"  id="path1ticksR">
                <custom-checkbox/>
            </div>
            <div class="path1txt" id="path1txtR">
                <h3 id="kit" class="clickh3">Received the kit</h3>
            </div>
        </section>


        <section id="progress2">
            <h4 id="hardware">Hardware</h4>
            <svg class="pathJoin" viewBox="0 0 100 50" preserveAspectRatio="none">
                <path d="M 5,50 C 5,25 50,25 50.2,0" fill="none" stroke="#3A3A3A" stroke-width="4.9"/>
                <path d="M 94.8,50 C 95,25 50,25 50,0" fill="none" stroke="#3A3A3A" stroke-width="4.9"/>
            </svg>
            <h4 id="electronics">Electronics</h4>
        </section>


        <section id="progress3">
            <div class="path3txt" id="path3txtL">
                <h3 id="cutmdf" class="clickh3">Cut & drilled & couter-sunk holdes in the MDF wood</h3>
                <h3 id="alum" class="clickh3">Cut & drilled & counter-sunk holes in aluminium brackets</h3>
                <h3 id="chassis" class="clickh3">Fully assembled the chassis</h3>
                <h3 id="chuck" class="clickh3">Replaced both drill chucks with wheels</h3>
                <h3 id="dsmtl" class="clickh3">Dismantled both drills</h3>
                <h3 id="drillcut" class="clickh3">Cut drill cases to size, drilled holes & crimped wires</h3>
                <h3 id="motors" class="clickh3">Fitted motors to chassis</h3>
                <h3 id="balance" class="clickh3">Fitted balancing wheels to chassis</h3>
                <h3 id="battery" class="clickh3">Fitted batteries to chassis</h3>
                <h3 id="rear" class="clickh3">Fitted rear safety lights & tow hook</h3>
            </div>
            <div class="path3ticks" id="path3ticksL">
                <custom-checkbox></custom-checkbox>
                <custom-checkbox></custom-checkbox>
                <custom-checkbox></custom-checkbox>
                <custom-checkbox></custom-checkbox>
                <custom-checkbox></custom-checkbox>
                <custom-checkbox></custom-checkbox>
                <custom-checkbox></custom-checkbox>
                <custom-checkbox></custom-checkbox>
                <custom-checkbox></custom-checkbox>
                <custom-checkbox></custom-checkbox>
            </div>
            <span class="path" id="path3L"></span>
            <span class="path" id="path3R"></span>
            <div class="path3ticks" id="path3ticksR">
                <custom-checkbox></custom-checkbox>                
                <custom-checkbox></custom-checkbox>
                <custom-checkbox></custom-checkbox>
                <custom-checkbox></custom-checkbox>
                <custom-checkbox></custom-checkbox>
                <custom-checkbox></custom-checkbox>
                <custom-checkbox></custom-checkbox>
                <custom-checkbox></custom-checkbox>
                <custom-checkbox></custom-checkbox>
                <custom-checkbox></custom-checkbox>
                <custom-checkbox></custom-checkbox>
            </div>
            <div class="path3txt" id="path3txtR">
                <h3 id="pcb" class="clickh3">Soldered 1st PCB</h3>
                <h3 id="pcb2" class="clickh3">Soldered 2nd PCB</h3>
                <h3 id="testEquip" class="clickh3">Made test equipment</h3>
                <h3 id="voltages" class="clickh3">Checked 1st PCB board voltages (without PIC)</h3>
                <h3 id="voltages2" class="clickh3">Checked 2nd PCB board voltages (without PIC)</h3>
                <h3 id="lamptest" class="clickh3">Tested 1st PCB LED (with PIC)</h3>
                <h3 id="lamptest2" class="clickh3">Tested 2nd PCB LED (with PIC)</h3>
                <h3 id="motortest" class="clickh3">Tested 1st PCB with motor (with PIC & driver IC)</h3>
                <h3 id="motortest2" class="clickh3">Tested 2nd PCB with motor (with PIC & driver IC)</h3>
                <h3 id="pcbw1" class="clickh3">1st PCB works!</h3>
                <h3 id="pcbw2" class="clickh3">2nd PCB works!</h3>
            </div>
        </section>


        <section id="progress4">
            <svg class="pathJoin" viewBox="0 0 100 50" preserveAspectRatio="none">
                <path d="M 5.2,0 C 5,25 50,25 50,50" fill="none" stroke="#3A3A3A" stroke-width="4.9"/>
                <path d="M 94.8,0 C 95,25 50,25 50,50" fill="none" stroke="#3A3A3A" stroke-width="4.9"/>
            </svg>
        </section>


        <section id="progress5">
            <div class="path5txt" id="path5txtL">
                <h3 id="pcbs" class="clickh3">Fitted PCB Boards to chassis</h3>
                <h3 id="fuse" class="clickh3">Added a fuse and switch to wiring</h3>
                <h3 id="drive" class="clickh3">Driven working chariot around!</h3>
                <h3 id="site" class="clickh3">Arrived at Leonardo on the 28th of June for the competition</h3>
            </div>
            <div class="path5ticks" id="path5ticksL">
                <custom-checkbox></custom-checkbox>
                <custom-checkbox></custom-checkbox>
                <custom-checkbox></custom-checkbox>
                <custom-checkbox></custom-checkbox>
            </div>
            <span class="path" id="path5"></span>
            <div class="path5ticks" id="path5ticksR">
                <custom-checkbox></custom-checkbox>
                <custom-checkbox></custom-checkbox>
                <custom-checkbox></custom-checkbox>
            </div>
            <div class="path5txt" id="path5txtR">
                <h3 id="radio" class="clickh3">Fitted Radio Receiver to chassis</h3>
                <h3 id="trim" class="clickh3">Adjusted remote controller trim</h3>
                <h3 id="mot" class="clickh3">Performed the M.O.T.</h3>       
            </div>
        </section>


        <section id="progress6">
            <span class="terminal">End</span>
        </section>


    </main> 





    <div id="confetti-container"></div>
    <div class="picBg"><img></div>
    <div id="mobileMessage">
        <p>Please view full content on desktop</p>
    </div>





    <template id="custom-checkbox-template">
        <style>
            .checkbox-container {
                display: inline-block;
                position: relative;
                width: 30px;
                height: 30px;
                border-radius: 5px;
                cursor: pointer;
                background-color: rgb(229, 229, 229);
            }

            .checkbox-container img {
                position: absolute;
                top: -15%;
                left: 20%;
                width: 30px;
                height: 30px;
                display: none;
            }

            .checkbox-container.checked img {
                display: block;
            }
        </style>
        <div class="checkbox-container">
            <img src="images/tick.png" alt="Tick">
        </div>
    </template>

    <script>
        class CustomCheckbox extends HTMLElement {
            constructor() {
                super();
                const template = document.getElementById('custom-checkbox-template').content.cloneNode(true);
                this.attachShadow({ mode: 'open' }).appendChild(template);

                this.checkboxContainer = this.shadowRoot.querySelector('.checkbox-container');

                this.checkboxContainer.addEventListener('click', () => {
                    this.checkboxContainer.classList.toggle('checked');
                    progressHasChanged = true;
                    setTimeout(updateProgressBar, 0); // Ensure updateProgressBar is called after DOM updates
                    if (this.checkboxContainer.classList.contains('checked')) {
                        triggerConfetti();
                    }
                });
            }
        }
        customElements.define('custom-checkbox', CustomCheckbox);

        function updateProgressBar() {
            const totalCheckboxes = document.querySelectorAll('custom-checkbox').length || 30;
            let checkedCheckboxes = 0;

            // Count checkboxes with the 'checked' class in their shadow DOM
            document.querySelectorAll('custom-checkbox').forEach(checkbox => {
                const shadowCheckbox = checkbox.shadowRoot.querySelector('.checkbox-container');
                if (shadowCheckbox && shadowCheckbox.classList.contains('checked')) {
                    checkedCheckboxes++;
                }
            });

            console.log('totalCheckboxes:', totalCheckboxes);
            const progressPercentage = Math.round((checkedCheckboxes / totalCheckboxes) * 100);
            const progressBarFill = document.getElementById('progressBarFill');
            progressBarFill.style.width = `${progressPercentage}%`;
            progressBarFill.textContent = `${progressPercentage}%`;

            // Change text color to red if progress is less than 10%
            if (progressPercentage < 10) {
                progressBarFill.style.color = '#E93838';
            } else {
                progressBarFill.style.color = ''; // Reset to default color
            }
            if (progressPercentage == 0) {
                progressBarFill.style.backgroundColor = '#3A3A3A';
            } else {
                progressBarFill.style.backgroundColor = '#f8f8f8';
            }
        }

        function triggerConfetti() {
            const container = document.getElementById('confetti-container');
            const confettiCount = 100;
            const colors = ['#FF5733', '#33FF57', '#3357FF', '#F3FF33', '#FF33A8'];
            const gravity = 5.0; // Increased gravity for faster fall

            for (let i = 0; i < confettiCount; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.left = `${Math.random() * 100}%`; // Correctly calculate left position as a percentage
                confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
                container.appendChild(confetti);

                const startX = Math.random() * window.innerWidth -500; // Use window width for animation start
                const startY = -50 - Math.random() * 600; // Randomize Y start position off-screen
                const endX = startX + (Math.random() - 0.5) * 200;
                const endY = window.innerHeight + 100; // Increased end position for stronger gravity
                const duration = 2 + Math.random() * 1.6; // Faster animation

                confetti.animate([
                    { transform: `translate(${startX}px, ${startY}px) rotate(${Math.random() * 360}deg)` },
                    { transform: `translate(${endX}px, ${endY}px) rotate(${Math.random() * 720}deg)` }
                ], {
                    duration: duration * 1000,
                    easing: 'ease-out',
                    iterations: 1,
                    fill: 'forwards'
                });

                setTimeout(() => confetti.remove(), duration * 1000);
            }
        }


        fetchSchoolProgress();
        // func to fetch school progress data
        async function fetchSchoolProgress() {
            const urlParams = new URLSearchParams(window.location.search);
            const schoolName = urlParams.get('school');
            if (schoolName) {
                const schoolNameElement = document.getElementById('schoolName');
                schoolNameElement.textContent = `${schoolName}:`;
            }
            try {
                const response = await fetch(`https://rc-school-tracking.onrender.com/school-progress/${schoolName}`); 
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                const data = await response.json();
                console.log(data); // Process the data as needed
                updateCheckboxes(data.progress || []); // Update checkboxes with progress data or default to empty array
            } catch (error) {
                console.error('Error fetching school progress:', error);
            }
        }

        function updateCheckboxes(progress) {
            const checkboxes = document.querySelectorAll('custom-checkbox');
            checkboxes.forEach((checkbox, index) => {
                const shadowCheckbox = checkbox.shadowRoot.querySelector('.checkbox-container');
                if (shadowCheckbox) {
                    if (progress[index] === 1) {
                        shadowCheckbox.classList.add('checked');
                    } else {
                        shadowCheckbox.classList.remove('checked');
                    }
                }
            });
            updateProgressBar(); // Update the progress bar after setting checkbox states
        }

        let progressHasChanged = false;
        // Func to send data to server after 5s.
        setInterval(async () => {
            if (progressHasChanged) {
                const checkboxes = document.querySelectorAll('custom-checkbox');
                const progressData = Array.from(checkboxes).map(checkbox => {
                    const shadowCheckbox = checkbox.shadowRoot.querySelector('.checkbox-container');
                    return shadowCheckbox.classList.contains('checked') ? 1 : 0;
                });
                const urlParams = new URLSearchParams(window.location.search);
                const schoolName = urlParams.get('school');
                const schoolKey = urlParams.get('key');
                // console.log('schoolName:', schoolName, 'schoolKey:', schoolKey);
                // console.log('progressData:', progressData);
                try {
                    const response = await fetch(`https://rc-school-tracking.onrender.com/school-progress`, {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            name: schoolName,
                            progress: progressData,
                            password: schoolKey
                        })
                    });
                    const data = await response.json();
                } catch (error) {
                    console.error('Error saving progress:', error);
                }
                progressHasChanged = false;
            }
        }, 5000);


        // Adds school info to url for navigatoin
        document.getElementById('allPropLink').addEventListener('click', function (event) {
            event.preventDefault();
            const params = new URLSearchParams(window.location.search);
            const school = params.get('school');
            const key = params.get('key');
            const newUrl = `./all-progress.html?school=${encodeURIComponent(school)}&key=${encodeURIComponent(key)}`;
            window.location.href = newUrl;
        });
        document.getElementById('docsLink').addEventListener('click', function (event) {
            event.preventDefault();
            const params = new URLSearchParams(window.location.search);
            const school = params.get('school');
            const key = params.get('key');
            const newUrl = `./documents.html?school=${encodeURIComponent(school)}&key=${encodeURIComponent(key)}`;
            window.location.href = newUrl;
        });

        window.addEventListener('load', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const school = urlParams.get('school');
            const key = urlParams.get('key');

            if (!school || !key || school == 'null' || key === 'null') {
                alert('Error: Cannot find school login details. Please login again.');
                window.location.href = './index.html';
                return;
            }

            const header = document.querySelector('header');
            setTimeout(() => {
                header.classList.add('shrink');
            }, 0); // Trigger animation immediately after page load
        });

        document.querySelectorAll('h3.clickh3').forEach(h3 => {
            h3.addEventListener('click', function () {
                const picBg = document.querySelector('.picBg');
                const img = picBg.querySelector('img');

                // Toggle visibility if the same image is already displayed
                if (img.src.includes(`${this.id}.jpeg`)) {
                    const isVisible = picBg.classList.contains('show');
                    picBg.classList.toggle('show', !isVisible); // Toggle the 'show' class
                    this.style.color = isVisible ? '' : 'white'; // Reset or set text color
                    this.style.zIndex = isVisible ? '' : '1100'; // Reset or set z-index

                    // Reset checkbox z-index
                    const index = Array.from(this.parentElement.children).indexOf(this);
                    //const checkboxParentId = this.parentElement.id === 'path3txtL' ? 'path3ticksL' : 'path3ticksR';
                    const checkboxParentId = this.parentElement.id.replace('txt', 'ticks'); 
                    const checkbox = document.querySelector(`#${checkboxParentId}`).children[index];
                    checkbox.style.zIndex = isVisible ? '' : '1100'; // Reset or set z-index
                    return;
                }

                // Update the image source
                img.src = `./images/${this.id}.jpeg`;

                // Determine alignment based on parent id
                const rect = this.getBoundingClientRect();
                const isLeftAligned = this.parentElement.id === 'path3txtL';
                const isRightAligned = this.parentElement.id.includes('R');

                const top = window.scrollY + rect.top - 10;
                let left;
                if (isLeftAligned) {
                    left = window.scrollX + rect.right - 480;
                } else if (isRightAligned) {
                    left = window.scrollX + rect.left - 16 * 5;
                } else {
                    left = window.scrollX + rect.right - 16 * 30;
                }

                // Set transform instead of top/left
                picBg.style.transform = `scale(1) translate(${left}px, ${top}px)`;
                picBg.classList.add('show'); // Add the 'show' class for transition

                // Temporarily change h3 text color and z-index
                this.style.color = 'white';
                this.style.zIndex = '1100';

                // Highlight the corresponding checkbox
                const index = Array.from(this.parentElement.children).indexOf(this);
                const checkboxParentId = this.parentElement.id.replace('txt', 'ticks'); 
                const checkbox = document.querySelector(`#${checkboxParentId}`).children[index];
                checkbox.style.zIndex = '1100';

                // Reset styles for other h3 elements and checkboxes
                document.querySelectorAll('h3.clickh3').forEach(otherH3 => {
                    if (otherH3 !== this) {
                        otherH3.style.color = ''; // Reset text color
                        otherH3.style.zIndex = ''; // Reset z-index
                    }
                });
                document.querySelectorAll('custom-checkbox').forEach(otherCheckbox => {
                    if (otherCheckbox !== checkbox) {
                        otherCheckbox.style.zIndex = ''; // Reset z-index
                    }
                });
            });
        });
    </script>
</body>
</html>